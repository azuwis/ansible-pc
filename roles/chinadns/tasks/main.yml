---
- name: install dnsmasq
  apt: name=dnsmasq

- name: config dnsmasq
  copy:
    src: dnsmasq.conf
    dest: /etc/dnsmasq.d/chinadns.conf
  notify: restart dnsmasq

- name: install systemd service for chinadns
  copy:
    src: chinadns.service
    dest: /etc/systemd/system/

- name: copy environ file for chinadns
  copy:
    src: chinadns.default
    dest: /etc/default/chinadns
  notify: restart chinadns

- name: get iplist for chinadns
  get_url:
    dest: /etc/chinadns.list
    url: https://github.com/clowwindy/ChinaDNS/raw/master/iplist.txt
  notify: restart chinadns

- name: enable systemd service for chinadns
  service:
    name: chinadns
    state: started
    enabled: yes

- name: install unbound
  apt: name=unbound

- name: config /etc/default/unbound
  lineinfile:
    dest: /etc/default/unbound
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - regexp: ^ROOT_TRUST_ANCHOR_UPDATE=
      line: ROOT_TRUST_ANCHOR_UPDATE=false
    - regexp: ^RESOLVCONF=
      line: RESOLVCONF=false
    - regexp: ^RESOLVCONF_FORWARDERS=
      line: RESOLVCONF_FORWARDERS=false
  notify: restart unbound

- name: config unbound
  copy:
    src: unbound.conf
    dest: /etc/unbound/unbound.conf.d/chinadns.conf
  notify: restart unbound
